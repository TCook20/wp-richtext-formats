import"@preact/signals";import{useMemo as e}from"preact/hooks";import{Signal as t,signal as r,computed as s}from"@preact/signals-core";const n=new WeakMap,o=new WeakMap,a=new WeakMap,c=new WeakSet,l=new WeakMap,g=/^\$/;let i=!1;const h=e=>{if(!d(e))throw new Error("This object can't be observed.");return o.has(e)||o.set(e,u(e,w)),o.get(e)},p=(e,t)=>{i=!0;const r=e[t];try{i=!1}catch(e){}return r},u=(e,t)=>{const r=new Proxy(e,t);return c.add(r),r},f=()=>{throw new Error("Don't mutate the signals directly.")},y=e=>(t,c,l)=>{var h;if(i)return Reflect.get(t,c,l);let p=e||"$"===c[0];if(!e&&p&&Array.isArray(t)){if("$"===c)return a.has(t)||a.set(t,u(t,m)),a.get(t);p="$length"===c}n.has(l)||n.set(l,new Map);const f=n.get(l),y=p?c.replace(g,""):c;if(f.has(y)||"function"!=typeof(null==(h=Object.getOwnPropertyDescriptor(t,y))?void 0:h.get)){let e=Reflect.get(t,y,l);if(p&&"function"==typeof e)return;if("symbol"==typeof y&&b.has(y))return e;f.has(y)||(d(e)&&(o.has(e)||o.set(e,u(e,w)),e=o.get(e)),f.set(y,r(e)))}else f.set(y,s(()=>Reflect.get(t,y,l)));return p?f.get(y):f.get(y).value},w={get:y(!1),set(e,s,a,c){n.has(c)||n.set(c,new Map);const i=n.get(c);if("$"===s[0]){a instanceof t||f();const r=s.replace(g,"");return i.set(r,a),Reflect.set(e,r,a.peek(),c)}{let t=a;d(a)&&(o.has(a)||o.set(a,u(a,w)),t=o.get(a));const n=!(s in e),g=Reflect.set(e,s,a,c);return i.has(s)?i.get(s).value=t:i.set(s,r(t)),n&&l.has(e)&&l.get(e).value++,Array.isArray(e)&&i.has("length")&&(i.get("length").value=e.length),g}},deleteProperty(e,t){"$"===t[0]&&f();const r=n.get(o.get(e)),s=Reflect.deleteProperty(e,t);return r&&r.has(t)&&(r.get(t).value=void 0),l.has(e)&&l.get(e).value++,s},ownKeys:e=>(l.has(e)||l.set(e,r(0)),l._=l.get(e).value,Reflect.ownKeys(e))},m={get:y(!0),set:f,deleteProperty:f},b=new Set(Object.getOwnPropertyNames(Symbol).map(e=>Symbol[e]).filter(e=>"symbol"==typeof e)),v=new Set([Object,Array]),d=e=>"object"==typeof e&&null!==e&&(!("function"==typeof e.constructor&&e.constructor.name in globalThis&&globalThis[e.constructor.name]===e.constructor)||v.has(e.constructor))&&!c.has(e),k=t=>e(()=>h(t),[]);export{h as deepSignal,p as peek,k as useDeepSignal};//# sourceMappingURL=deepsignal.mjs.map
