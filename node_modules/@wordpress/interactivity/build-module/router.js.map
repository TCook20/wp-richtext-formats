{"version":3,"names":["hydrate","render","toVdom","hydratedIslands","createRootFragment","directivePrefix","pages","Map","regionRootFragments","WeakMap","getRegionRootFragment","region","has","set","parentElement","get","cleanUrl","url","u","URL","window","location","pathname","search","fetchPage","html","res","fetch","status","text","dom","DOMParser","parseFromString","regionsToVdom","e","regions","attrName","querySelectorAll","forEach","id","getAttribute","prefetch","options","force","renderRegions","page","document","fragment","navigate","href","history","replace","assign","addEventListener","reload","init","node","vdom","Promise","resolve"],"sources":["@wordpress/interactivity/src/router.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { hydrate, render } from 'preact';\n/**\n * Internal dependencies\n */\nimport { toVdom, hydratedIslands } from './vdom';\nimport { createRootFragment } from './utils';\nimport { directivePrefix } from './constants';\n\n// The cache of visited and prefetched pages.\nconst pages = new Map();\n\n// Keep the same root fragment for each interactive region node.\nconst regionRootFragments = new WeakMap();\nconst getRegionRootFragment = ( region ) => {\n\tif ( ! regionRootFragments.has( region ) ) {\n\t\tregionRootFragments.set(\n\t\t\tregion,\n\t\t\tcreateRootFragment( region.parentElement, region )\n\t\t);\n\t}\n\treturn regionRootFragments.get( region );\n};\n\n// Helper to remove domain and hash from the URL. We are only interesting in\n// caching the path and the query.\nconst cleanUrl = ( url ) => {\n\tconst u = new URL( url, window.location );\n\treturn u.pathname + u.search;\n};\n\n// Fetch a new page and convert it to a static virtual DOM.\nconst fetchPage = async ( url, { html } ) => {\n\ttry {\n\t\tif ( ! html ) {\n\t\t\tconst res = await window.fetch( url );\n\t\t\tif ( res.status !== 200 ) return false;\n\t\t\thtml = await res.text();\n\t\t}\n\t\tconst dom = new window.DOMParser().parseFromString( html, 'text/html' );\n\t\treturn regionsToVdom( dom );\n\t} catch ( e ) {\n\t\treturn false;\n\t}\n};\n\n// Return an object with VDOM trees of those HTML regions marked with a\n// `navigation-id` directive.\nconst regionsToVdom = ( dom ) => {\n\tconst regions = {};\n\tconst attrName = `data-${ directivePrefix }-navigation-id`;\n\tdom.querySelectorAll( `[${ attrName }]` ).forEach( ( region ) => {\n\t\tconst id = region.getAttribute( attrName );\n\t\tregions[ id ] = toVdom( region );\n\t} );\n\n\treturn { regions };\n};\n\n// Prefetch a page. We store the promise to avoid triggering a second fetch for\n// a page if a fetching has already started.\nexport const prefetch = ( url, options = {} ) => {\n\turl = cleanUrl( url );\n\tif ( options.force || ! pages.has( url ) ) {\n\t\tpages.set( url, fetchPage( url, options ) );\n\t}\n};\n\n// Render all interactive regions contained in the given page.\nconst renderRegions = ( page ) => {\n\tconst attrName = `data-${ directivePrefix }-navigation-id`;\n\tdocument.querySelectorAll( `[${ attrName }]` ).forEach( ( region ) => {\n\t\tconst id = region.getAttribute( attrName );\n\t\tconst fragment = getRegionRootFragment( region );\n\t\trender( page.regions[ id ], fragment );\n\t} );\n};\n\n// Navigate to a new page.\nexport const navigate = async ( href, options = {} ) => {\n\tconst url = cleanUrl( href );\n\tprefetch( url, options );\n\tconst page = await pages.get( url );\n\tif ( page ) {\n\t\trenderRegions( page );\n\t\twindow.history[ options.replace ? 'replaceState' : 'pushState' ](\n\t\t\t{},\n\t\t\t'',\n\t\t\thref\n\t\t);\n\t} else {\n\t\twindow.location.assign( href );\n\t}\n};\n\n// Listen to the back and forward buttons and restore the page if it's in the\n// cache.\nwindow.addEventListener( 'popstate', async () => {\n\tconst url = cleanUrl( window.location ); // Remove hash.\n\tconst page = pages.has( url ) && ( await pages.get( url ) );\n\tif ( page ) {\n\t\trenderRegions( page );\n\t} else {\n\t\twindow.location.reload();\n\t}\n} );\n\n// Initialize the router with the initial DOM.\nexport const init = async () => {\n\tdocument\n\t\t.querySelectorAll( `[data-${ directivePrefix }-interactive]` )\n\t\t.forEach( ( node ) => {\n\t\t\tif ( ! hydratedIslands.has( node ) ) {\n\t\t\t\tconst fragment = getRegionRootFragment( node );\n\t\t\t\tconst vdom = toVdom( node );\n\t\t\t\thydrate( vdom, fragment );\n\t\t\t}\n\t\t} );\n\n\t// Cache the current regions.\n\tpages.set(\n\t\tcleanUrl( window.location ),\n\t\tPromise.resolve( regionsToVdom( document ) )\n\t);\n};\n"],"mappings":"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"}