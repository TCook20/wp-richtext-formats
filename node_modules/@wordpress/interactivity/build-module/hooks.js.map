{"version":3,"names":["h","options","createContext","cloneElement","useRef","useCallback","rawStore","store","context","directiveCallbacks","directivePriorities","directive","name","callback","priority","resolve","path","ctx","current","split","forEach","p","getEvaluate","ref","extraArgs","hasNegationOperator","slice","value","returnValue","getPriorityLevels","directives","byPriority","Object","keys","reduce","obj","push","entries","sort","p1","p2","map","arr","Directives","priorityLevels","currentPriorityLevel","nextPriorityLevels","element","evaluate","originalProps","elemRef","children","length","createElement","props","directiveArgs","directiveName","wrapper","undefined","old","vnode","__directives","key","default","type","top"],"sources":["@wordpress/interactivity/src/hooks.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { h, options, createContext, cloneElement } from 'preact';\nimport { useRef, useCallback } from 'preact/hooks';\n/**\n * Internal dependencies\n */\nimport { rawStore as store } from './store';\n\n/** @typedef {import('preact').VNode} VNode */\n/** @typedef {typeof context} Context */\n/** @typedef {ReturnType<typeof getEvaluate>} Evaluate */\n\n/**\n * @typedef {Object} DirectiveCallbackParams Callback parameters.\n * @property {Object}   directives Object map with the defined directives of the element being evaluated.\n * @property {Object}   props      Props present in the current element.\n * @property {VNode}    element    Virtual node representing the original element.\n * @property {Context}  context    The inherited context.\n * @property {Evaluate} evaluate   Function that resolves a given path to a value either in the store or the context.\n */\n\n/**\n * @callback DirectiveCallback Callback that runs the directive logic.\n * @param {DirectiveCallbackParams} params Callback parameters.\n */\n\n/**\n * @typedef DirectiveOptions Options object.\n * @property {number} [priority=10] Value that specifies the priority to\n *                                  evaluate directives of this type. Lower\n *                                  numbers correspond with earlier execution.\n *                                  Default is `10`.\n */\n\n// Main context.\nconst context = createContext( {} );\n\n// WordPress Directives.\nconst directiveCallbacks = {};\nconst directivePriorities = {};\n\n/**\n * Register a new directive type in the Interactivity API runtime.\n *\n * @example\n * ```js\n * directive(\n *   'alert', // Name without the `data-wp-` prefix.\n *   ( { directives: { alert }, element, evaluate }) => {\n *     element.props.onclick = () => {\n *       alert( evaluate( alert.default ) );\n *     }\n *   }\n * )\n * ```\n *\n * The previous code registers a custom directive type for displaying an alert\n * message whenever an element using it is clicked. The message text is obtained\n * from the store using `evaluate`.\n *\n * When the HTML is processed by the Interactivity API, any element containing\n * the `data-wp-alert` directive will have the `onclick` event handler, e.g.,\n *\n * ```html\n * <button data-wp-alert=\"state.messages.alert\">Click me!</button>\n * ```\n * Note that, in the previous example, you access `alert.default` in order to\n * retrieve the `state.messages.alert` value passed to the directive. You can\n * also define custom names by appending `--` to the directive attribute,\n * followed by a suffix, like in the following HTML snippet:\n *\n * ```html\n * <button\n *   data-wp-color--text=\"state.theme.text\"\n *   data-wp-color--background=\"state.theme.background\"\n * >Click me!</button>\n * ```\n *\n * This could be an hypothetical implementation of the custom directive used in\n * the snippet above.\n *\n * @example\n * ```js\n * directive(\n *   'color', // Name without prefix and suffix.\n *   ( { directives: { color }, ref, evaluate }) => {\n *     if ( color.text ) {\n * \t     ref.style.setProperty(\n *         'color',\n *         evaluate( color.text )\n *       );\n *     }\n *     if ( color.background ) {\n *       ref.style.setProperty(\n *         'background-color',\n *         evaluate( color.background )\n *       );\n *     }\n *   }\n * )\n * ```\n *\n * @param {string}            name     Directive name, without the `data-wp-` prefix.\n * @param {DirectiveCallback} callback Function that runs the directive logic.\n * @param {DirectiveOptions=} options  Options object.\n */\nexport const directive = ( name, callback, { priority = 10 } = {} ) => {\n\tdirectiveCallbacks[ name ] = callback;\n\tdirectivePriorities[ name ] = priority;\n};\n\n// Resolve the path to some property of the store object.\nconst resolve = ( path, ctx ) => {\n\tlet current = { ...store, context: ctx };\n\tpath.split( '.' ).forEach( ( p ) => ( current = current[ p ] ) );\n\treturn current;\n};\n\n// Generate the evaluate function.\nconst getEvaluate =\n\t( { ref } = {} ) =>\n\t( path, extraArgs = {} ) => {\n\t\t// If path starts with !, remove it and save a flag.\n\t\tconst hasNegationOperator =\n\t\t\tpath[ 0 ] === '!' && !! ( path = path.slice( 1 ) );\n\t\tconst value = resolve( path, extraArgs.context );\n\t\tconst returnValue =\n\t\t\ttypeof value === 'function'\n\t\t\t\t? value( {\n\t\t\t\t\t\tref: ref.current,\n\t\t\t\t\t\t...store,\n\t\t\t\t\t\t...extraArgs,\n\t\t\t\t  } )\n\t\t\t\t: value;\n\t\treturn hasNegationOperator ? ! returnValue : returnValue;\n\t};\n\n// Separate directives by priority. The resulting array contains objects\n// of directives grouped by same priority, and sorted in ascending order.\nconst getPriorityLevels = ( directives ) => {\n\tconst byPriority = Object.keys( directives ).reduce( ( obj, name ) => {\n\t\tif ( directiveCallbacks[ name ] ) {\n\t\t\tconst priority = directivePriorities[ name ];\n\t\t\t( obj[ priority ] = obj[ priority ] || [] ).push( name );\n\t\t}\n\t\treturn obj;\n\t}, {} );\n\n\treturn Object.entries( byPriority )\n\t\t.sort( ( [ p1 ], [ p2 ] ) => p1 - p2 )\n\t\t.map( ( [ , arr ] ) => arr );\n};\n\n// Priority level wrapper.\nconst Directives = ( {\n\tdirectives,\n\tpriorityLevels: [ currentPriorityLevel, ...nextPriorityLevels ],\n\telement,\n\tevaluate,\n\toriginalProps,\n\telemRef,\n} ) => {\n\t// Initialize the DOM reference.\n\t// eslint-disable-next-line react-hooks/rules-of-hooks\n\telemRef = elemRef || useRef( null );\n\n\t// Create a reference to the evaluate function using the DOM reference.\n\t// eslint-disable-next-line react-hooks/rules-of-hooks, react-hooks/exhaustive-deps\n\tevaluate = evaluate || useCallback( getEvaluate( { ref: elemRef } ), [] );\n\n\t// Create a fresh copy of the vnode element.\n\telement = cloneElement( element, { ref: elemRef } );\n\n\t// Recursively render the wrapper for the next priority level.\n\tconst children =\n\t\tnextPriorityLevels.length > 0 ? (\n\t\t\t<Directives\n\t\t\t\tdirectives={ directives }\n\t\t\t\tpriorityLevels={ nextPriorityLevels }\n\t\t\t\telement={ element }\n\t\t\t\tevaluate={ evaluate }\n\t\t\t\toriginalProps={ originalProps }\n\t\t\t\telemRef={ elemRef }\n\t\t\t/>\n\t\t) : (\n\t\t\telement\n\t\t);\n\n\tconst props = { ...originalProps, children };\n\tconst directiveArgs = { directives, props, element, context, evaluate };\n\n\tfor ( const directiveName of currentPriorityLevel ) {\n\t\tconst wrapper = directiveCallbacks[ directiveName ]?.( directiveArgs );\n\t\tif ( wrapper !== undefined ) props.children = wrapper;\n\t}\n\n\treturn props.children;\n};\n\n// Preact Options Hook called each time a vnode is created.\nconst old = options.vnode;\noptions.vnode = ( vnode ) => {\n\tif ( vnode.props.__directives ) {\n\t\tconst props = vnode.props;\n\t\tconst directives = props.__directives;\n\t\tif ( directives.key ) vnode.key = directives.key.default;\n\t\tdelete props.__directives;\n\t\tconst priorityLevels = getPriorityLevels( directives );\n\t\tif ( priorityLevels.length > 0 ) {\n\t\t\tvnode.props = {\n\t\t\t\tdirectives,\n\t\t\t\tpriorityLevels,\n\t\t\t\toriginalProps: props,\n\t\t\t\ttype: vnode.type,\n\t\t\t\telement: h( vnode.type, props ),\n\t\t\t\ttop: true,\n\t\t\t};\n\t\t\tvnode.type = Directives;\n\t\t}\n\t}\n\n\tif ( old ) old( vnode );\n};\n"],"mappings":"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"}