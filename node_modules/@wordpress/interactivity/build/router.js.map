{"version":3,"names":["_preact","require","_vdom","_utils","_constants","pages","Map","regionRootFragments","WeakMap","getRegionRootFragment","region","has","set","createRootFragment","parentElement","get","cleanUrl","url","u","URL","window","location","pathname","search","fetchPage","html","res","fetch","status","text","dom","DOMParser","parseFromString","regionsToVdom","e","regions","attrName","directivePrefix","querySelectorAll","forEach","id","getAttribute","toVdom","prefetch","options","force","exports","renderRegions","page","document","fragment","render","navigate","href","history","replace","assign","addEventListener","reload","init","node","hydratedIslands","vdom","hydrate","Promise","resolve"],"sources":["@wordpress/interactivity/src/router.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { hydrate, render } from 'preact';\n/**\n * Internal dependencies\n */\nimport { toVdom, hydratedIslands } from './vdom';\nimport { createRootFragment } from './utils';\nimport { directivePrefix } from './constants';\n\n// The cache of visited and prefetched pages.\nconst pages = new Map();\n\n// Keep the same root fragment for each interactive region node.\nconst regionRootFragments = new WeakMap();\nconst getRegionRootFragment = ( region ) => {\n\tif ( ! regionRootFragments.has( region ) ) {\n\t\tregionRootFragments.set(\n\t\t\tregion,\n\t\t\tcreateRootFragment( region.parentElement, region )\n\t\t);\n\t}\n\treturn regionRootFragments.get( region );\n};\n\n// Helper to remove domain and hash from the URL. We are only interesting in\n// caching the path and the query.\nconst cleanUrl = ( url ) => {\n\tconst u = new URL( url, window.location );\n\treturn u.pathname + u.search;\n};\n\n// Fetch a new page and convert it to a static virtual DOM.\nconst fetchPage = async ( url, { html } ) => {\n\ttry {\n\t\tif ( ! html ) {\n\t\t\tconst res = await window.fetch( url );\n\t\t\tif ( res.status !== 200 ) return false;\n\t\t\thtml = await res.text();\n\t\t}\n\t\tconst dom = new window.DOMParser().parseFromString( html, 'text/html' );\n\t\treturn regionsToVdom( dom );\n\t} catch ( e ) {\n\t\treturn false;\n\t}\n};\n\n// Return an object with VDOM trees of those HTML regions marked with a\n// `navigation-id` directive.\nconst regionsToVdom = ( dom ) => {\n\tconst regions = {};\n\tconst attrName = `data-${ directivePrefix }-navigation-id`;\n\tdom.querySelectorAll( `[${ attrName }]` ).forEach( ( region ) => {\n\t\tconst id = region.getAttribute( attrName );\n\t\tregions[ id ] = toVdom( region );\n\t} );\n\n\treturn { regions };\n};\n\n// Prefetch a page. We store the promise to avoid triggering a second fetch for\n// a page if a fetching has already started.\nexport const prefetch = ( url, options = {} ) => {\n\turl = cleanUrl( url );\n\tif ( options.force || ! pages.has( url ) ) {\n\t\tpages.set( url, fetchPage( url, options ) );\n\t}\n};\n\n// Render all interactive regions contained in the given page.\nconst renderRegions = ( page ) => {\n\tconst attrName = `data-${ directivePrefix }-navigation-id`;\n\tdocument.querySelectorAll( `[${ attrName }]` ).forEach( ( region ) => {\n\t\tconst id = region.getAttribute( attrName );\n\t\tconst fragment = getRegionRootFragment( region );\n\t\trender( page.regions[ id ], fragment );\n\t} );\n};\n\n// Navigate to a new page.\nexport const navigate = async ( href, options = {} ) => {\n\tconst url = cleanUrl( href );\n\tprefetch( url, options );\n\tconst page = await pages.get( url );\n\tif ( page ) {\n\t\trenderRegions( page );\n\t\twindow.history[ options.replace ? 'replaceState' : 'pushState' ](\n\t\t\t{},\n\t\t\t'',\n\t\t\thref\n\t\t);\n\t} else {\n\t\twindow.location.assign( href );\n\t}\n};\n\n// Listen to the back and forward buttons and restore the page if it's in the\n// cache.\nwindow.addEventListener( 'popstate', async () => {\n\tconst url = cleanUrl( window.location ); // Remove hash.\n\tconst page = pages.has( url ) && ( await pages.get( url ) );\n\tif ( page ) {\n\t\trenderRegions( page );\n\t} else {\n\t\twindow.location.reload();\n\t}\n} );\n\n// Initialize the router with the initial DOM.\nexport const init = async () => {\n\tdocument\n\t\t.querySelectorAll( `[data-${ directivePrefix }-interactive]` )\n\t\t.forEach( ( node ) => {\n\t\t\tif ( ! hydratedIslands.has( node ) ) {\n\t\t\t\tconst fragment = getRegionRootFragment( node );\n\t\t\t\tconst vdom = toVdom( node );\n\t\t\t\thydrate( vdom, fragment );\n\t\t\t}\n\t\t} );\n\n\t// Cache the current regions.\n\tpages.set(\n\t\tcleanUrl( window.location ),\n\t\tPromise.resolve( regionsToVdom( document ) )\n\t);\n};\n"],"mappings":"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"}