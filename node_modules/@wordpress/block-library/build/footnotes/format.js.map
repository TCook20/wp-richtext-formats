{"version":3,"names":["_uuid","require","_i18n","_icons","_richText","_blockEditor","_data","_blocks","_lockUnlock","usesContextKey","unlock","privateApis","formatName","exports","POST_CONTENT_BLOCK_NAME","SYNCED_PATTERN_BLOCK_NAME","format","title","__","tagName","className","attributes","interactive","contentEditable","edit","Edit","value","onChange","isObjectActive","context","postType","registry","useRegistry","getSelectedBlockClientId","getBlocks","getBlockRootClientId","getBlockName","getBlockParentsByBlockName","select","blockEditorStore","hasFootnotesBlockType","useSelect","blocksStore","getBlockType","isBlockWithinPattern","_getBlockParentsByBlockName","_getSelectedBlockClientId","parentCoreBlocks","length","selectionChange","insertBlock","useDispatch","onClick","batch","id","object","replacements","start","createId","newValue","insertObject","type","innerHTML","end","selectedClientId","parentPostContent","blocks","fnBlock","queue","block","shift","name","push","innerBlocks","rootClientId","createBlock","undefined","clientId","_element","createElement","RichTextToolbarButton","icon","isActive"],"sources":["@wordpress/block-library/src/footnotes/format.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as createId } from 'uuid';\n\n/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\nimport { formatListNumbered as icon } from '@wordpress/icons';\nimport { insertObject } from '@wordpress/rich-text';\nimport {\n\tRichTextToolbarButton,\n\tstore as blockEditorStore,\n\tprivateApis,\n} from '@wordpress/block-editor';\nimport { useSelect, useDispatch, useRegistry } from '@wordpress/data';\nimport { createBlock, store as blocksStore } from '@wordpress/blocks';\n\n/**\n * Internal dependencies\n */\nimport { unlock } from '../lock-unlock';\n\nconst { usesContextKey } = unlock( privateApis );\n\nexport const formatName = 'core/footnote';\n\nconst POST_CONTENT_BLOCK_NAME = 'core/post-content';\nconst SYNCED_PATTERN_BLOCK_NAME = 'core/block';\n\nexport const format = {\n\ttitle: __( 'Footnote' ),\n\ttagName: 'sup',\n\tclassName: 'fn',\n\tattributes: {\n\t\t'data-fn': 'data-fn',\n\t},\n\tinteractive: true,\n\tcontentEditable: false,\n\t[ usesContextKey ]: [ 'postType' ],\n\tedit: function Edit( {\n\t\tvalue,\n\t\tonChange,\n\t\tisObjectActive,\n\t\tcontext: { postType },\n\t} ) {\n\t\tconst registry = useRegistry();\n\t\tconst {\n\t\t\tgetSelectedBlockClientId,\n\t\t\tgetBlocks,\n\t\t\tgetBlockRootClientId,\n\t\t\tgetBlockName,\n\t\t\tgetBlockParentsByBlockName,\n\t\t} = registry.select( blockEditorStore );\n\t\tconst hasFootnotesBlockType = useSelect(\n\t\t\t( select ) =>\n\t\t\t\t!! select( blocksStore ).getBlockType( 'core/footnotes' ),\n\t\t\t[]\n\t\t);\n\t\t/*\n\t\t * This useSelect exists because we need to use its return value\n\t\t * outside the event callback.\n\t\t */\n\t\tconst isBlockWithinPattern = useSelect( ( select ) => {\n\t\t\tconst {\n\t\t\t\tgetBlockParentsByBlockName: _getBlockParentsByBlockName,\n\t\t\t\tgetSelectedBlockClientId: _getSelectedBlockClientId,\n\t\t\t} = select( blockEditorStore );\n\t\t\tconst parentCoreBlocks = _getBlockParentsByBlockName(\n\t\t\t\t_getSelectedBlockClientId(),\n\t\t\t\tSYNCED_PATTERN_BLOCK_NAME\n\t\t\t);\n\t\t\treturn parentCoreBlocks && parentCoreBlocks.length > 0;\n\t\t}, [] );\n\n\t\tconst { selectionChange, insertBlock } =\n\t\t\tuseDispatch( blockEditorStore );\n\n\t\tif ( ! hasFootnotesBlockType ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif ( postType !== 'post' && postType !== 'page' ) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Checks if the selected block lives within a pattern.\n\t\tif ( isBlockWithinPattern ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tfunction onClick() {\n\t\t\tregistry.batch( () => {\n\t\t\t\tlet id;\n\t\t\t\tif ( isObjectActive ) {\n\t\t\t\t\tconst object = value.replacements[ value.start ];\n\t\t\t\t\tid = object?.attributes?.[ 'data-fn' ];\n\t\t\t\t} else {\n\t\t\t\t\tid = createId();\n\t\t\t\t\tconst newValue = insertObject(\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: formatName,\n\t\t\t\t\t\t\tattributes: {\n\t\t\t\t\t\t\t\t'data-fn': id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tinnerHTML: `<a href=\"#${ id }\" id=\"${ id }-link\">*</a>`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tvalue.end,\n\t\t\t\t\t\tvalue.end\n\t\t\t\t\t);\n\t\t\t\t\tnewValue.start = newValue.end - 1;\n\t\t\t\t\tonChange( newValue );\n\t\t\t\t}\n\n\t\t\t\tconst selectedClientId = getSelectedBlockClientId();\n\n\t\t\t\t/*\n\t\t\t\t * Attempts to find a common parent post content block.\n\t\t\t\t * This allows for locating blocks within a page edited in the site editor.\n\t\t\t\t */\n\t\t\t\tconst parentPostContent = getBlockParentsByBlockName(\n\t\t\t\t\tselectedClientId,\n\t\t\t\t\tPOST_CONTENT_BLOCK_NAME\n\t\t\t\t);\n\n\t\t\t\t// When called with a post content block, getBlocks will return\n\t\t\t\t// the block with controlled inner blocks included.\n\t\t\t\tconst blocks = parentPostContent.length\n\t\t\t\t\t? getBlocks( parentPostContent[ 0 ] )\n\t\t\t\t\t: getBlocks();\n\n\t\t\t\t// BFS search to find the first footnote block.\n\t\t\t\tlet fnBlock = null;\n\t\t\t\t{\n\t\t\t\t\tconst queue = [ ...blocks ];\n\t\t\t\t\twhile ( queue.length ) {\n\t\t\t\t\t\tconst block = queue.shift();\n\t\t\t\t\t\tif ( block.name === 'core/footnotes' ) {\n\t\t\t\t\t\t\tfnBlock = block;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tqueue.push( ...block.innerBlocks );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Maybe this should all also be moved to the entity provider.\n\t\t\t\t// When there is no footnotes block in the post, create one and\n\t\t\t\t// insert it at the bottom.\n\t\t\t\tif ( ! fnBlock ) {\n\t\t\t\t\tlet rootClientId = getBlockRootClientId( selectedClientId );\n\n\t\t\t\t\twhile (\n\t\t\t\t\t\trootClientId &&\n\t\t\t\t\t\tgetBlockName( rootClientId ) !== POST_CONTENT_BLOCK_NAME\n\t\t\t\t\t) {\n\t\t\t\t\t\trootClientId = getBlockRootClientId( rootClientId );\n\t\t\t\t\t}\n\n\t\t\t\t\tfnBlock = createBlock( 'core/footnotes' );\n\n\t\t\t\t\tinsertBlock( fnBlock, undefined, rootClientId );\n\t\t\t\t}\n\n\t\t\t\tselectionChange( fnBlock.clientId, id, 0, 0 );\n\t\t\t} );\n\t\t}\n\n\t\treturn (\n\t\t\t<RichTextToolbarButton\n\t\t\t\ticon={ icon }\n\t\t\t\ttitle={ __( 'Footnote' ) }\n\t\t\t\tonClick={ onClick }\n\t\t\t\tisActive={ isObjectActive }\n\t\t\t/>\n\t\t);\n\t},\n};\n"],"mappings":"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"}